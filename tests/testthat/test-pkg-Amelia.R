skip_if_not_installed("Amelia")
withr_library("Amelia")


test_that("Amelia+mids", {
  skip_if_not_installed("mice")
  withr::local_seed(48103)

  dat <- iris
  dat$Sepal.Length[sample(seq_len(nrow(iris)), 40)] <- NA
  dat$Sepal.Width[sample(seq_len(nrow(iris)), 40)] <- NA
  dat$Species[sample(seq_len(nrow(iris)), 40)] <- NA

  dat_amelia <- Amelia::amelia(dat, m = 20, noms = "Species", p2s = 0)
  amest <- with(dat_amelia, lm(Petal.Width ~ Sepal.Length * Sepal.Width + Species))
  mod <- lm(Petal.Width ~ Sepal.Length * Sepal.Width + Species, data = dat)

  mfx1 <- avg_slopes(amest, by = "Species")
  mfx2 <- avg_slopes(mod, by = "Species")

  expect_s3_class(mfx1, "slopes")
  expect_equal(nrow(mfx1), nrow(mfx2))
})


test_that("avg_slopesAmelia + pooled logistic matches manual pooling (Issue #711)", {
  withr_library("mice")

  # fmt: skip
  data <- structure(list(id = 1:37, trt = c("soc", "soc", "soc", "soc", "soc", "soc", "soc", "soc", "soc", "soc", "soc", "soc", "soc", "soc", "soc", "soc", "soc", "soc", "soc", "soc", "soc", "arm", "arm", "arm", "arm", "arm", "arm", "arm", "arm", "arm", "arm", "arm", "arm", "arm", "arm", "arm", "arm"), endp = structure(c(1L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 2L, 2L, 2L, 2L, 2L, 1L, 1L, 1L, 1L), levels = c("TRUE", "FALSE"), class = "factor")), row.names = c(NA, -37L), class = "data.frame")
  data$endp <- factor(data$endp, levels = c("TRUE", "FALSE"))

  data_miss <- data
  data_miss[c(1, 5, 7, 30), "endp"] <- NA

  imp <- suppressWarnings(
    Amelia::amelia(data_miss, m = 20, noms = c("trt", "endp"), p2s = 0)
  )

  dat_amelia <- imp$imputations

  fit_logistic <- function(dat) {
    mod <- glm(endp ~ trt, family = binomial(link = "logit"), data = dat)
    avg_slopes(mod, newdata = dat)
  }

  mod_imputation <- suppressWarnings(lapply(dat_amelia, fit_logistic))
  manu <- suppressWarnings(summary(mice::pool(mod_imputation), conf.int = TRUE))

  fit <- with(imp, glm(endp ~ trt, family = binomial(link = "logit")))
  auto <- suppressWarnings(avg_slopes(fit))

  expect_equal(auto$estimate, manu$estimate, tolerance = 1e-12)
  expect_equal(auto$std.error, manu$std.error, tolerance = 1e-5)
})
