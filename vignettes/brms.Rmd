---
title: "Bayesian analysis with `brms` and `marginaleffects`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Marginal Effects}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  fig.width = 6,
  fig.asp = .4,
  out.width = "100%",
  warning = FALSE,
  message = FALSE,
  comment = "#>"
)

library(ggplot2)

theme_clean <- function() {
  theme_minimal() +
    theme(panel.grid.minor = element_blank(),
          strip.text = element_text(size = rel(1), hjust = 0),
          strip.background = element_blank(),
          legend.position = "bottom")
}
ggplot2::theme_set(theme_clean())
```

Support for `brms` is only available in the development version of `marginaleffects`:

```{r, eval = FALSE}
library(remotes)
install_github("vincentarelbundock/marginaleffects")
```

Bug reports and feature requests can be submitted here: https://github.com/vincentarelbundock/marginaleffects/issues

# Logistic regression with multiplicative interactions

Load libraries and download data on passengers of the Titanic from [the Rdatasets archive:](https://vincentarelbundock.github.io/Rdatasets/)

```{r, message = FALSE}
library(brms)
library(marginaleffects)
library(ggplot2)
library(ggdist)

dat <- read.csv("https://vincentarelbundock.github.io/Rdatasets/csv/carData/TitanicSurvival.csv")
dat$survived <- ifelse(dat$survived == "yes", 1, 0)
dat$woman <- ifelse(dat$sex == "female", 1, 0)
```

Fit a logit model with a multiplicative interaction:

```{r, message = FALSE, warning = FALSE, results = "hide"}
mod <- brm(survived ~ woman * age + passengerClass,
           family = bernoulli(link = "logit"),
           backend = "cmdstanr", cores = 4,
           data = dat)
```

## Adjusted predictions

We can compute [adjusted predicted values](https://vincentarelbundock.github.io/marginaleffects/articles/predictions.html) of the outcome variable (i.e., probability of survival aboard the Titanic) using the `predictions` function. By default, this function calculates predictions for each row of the dataset:

```{r}
pred <- predictions(mod)
head(pred)
```

To visualize the relationship between the outcome and one of the regressors, we can plot conditional adjusted predictions with the `plot_cap` function:

```{r}
plot_cap(mod, condition = "age")
```

Compute adjusted predictions for some user-specified values of the regressors, using the `newdata` argument and the `typical` function:

```{r}
pred <- predictions(mod, newdata = typical(woman = 0:1, passengerClass = c("1st", "2nd", "3rd")))
pred
```

The `get_posterior_draws` function samples from the posterior distribution of the model, and produces a data frame with `drawid` and `draw` columns.

```{r}
pred <- get_posterior_draws(pred)
head(pred)
```

This "long" format makes it easy to plots results:

```{r}
ggplot(pred, aes(x = draw, fill = factor(woman))) +
    geom_density() +
    facet_grid(~ passengerClass, labeller = label_both) +
    labs(x = "Predicted probability of survival", y = "", fill = "Woman")
```

## Marginal effects

Use `marginaleffects()` to [compute marginal effects (slopes of the regression equation)](https://vincentarelbundock.github.io/marginaleffects/articles/mfx.html) for each row of the dataset, and use `summary()` to compute "Average Marginal Effects", that is, the average of all observation-level marginal effects: 

```{r}
mfx <- marginaleffects(mod)
summary(mfx)
```

Compute marginal effects with some regressors fixed at user-specified values, and other regressors held at their means:

```{r}
marginaleffects(mod, newdata = typical(woman = 1, passengerClass = "1st"))
```

Compute and plot conditional marginal effects:

```{r}
plot_cme(mod, effect = "woman", condition = "age")
```

The `get_posterior_draws` produces a dataset with `drawid` and `draw` columns:

```{r}
draws <- get_posterior_draws(mfx)

dim(draws)

head(draws)
```

We can use this dataset to plot our results. For example, to plot the posterior density of the marginal effect of `age` when the `woman` variable is equal to 0 or 1:

```{r}
mfx <- marginaleffects(mod,
                       variables = "age",
                       newdata = typical(woman = 0:1)) |>
       get_posterior_draws()

ggplot(mfx, aes(x = draw, fill = factor(woman))) +
    stat_halfeye(slab_alpha = .5) +
    labs(x = "Marginal Effect of Age on Survival",
         y = "Posterior density",
         fill = "Woman")
```

# Random effects model

Andrew Heiss publishes a ton of useful resources on statistics in R on his website. In this section, I replicate his analysis of a random effects model published in this post: ["A guide to correctly calculating posterior predictions and average marginal effects with multilievel Bayesian models."](https://www.andrewheiss.com/blog/2021/11/10/ame-bayes-re-guide) My goal is only to illustrate the use of `marginaleffects`. Please refer to the original post for a detailed discussion of the quantities computed below.

Load libraries and clean data:

```{r, eval = FALSE}
remotes::install_github("vdeminstitute/vdemdata")
```

```{r, message = FALSE}
library(vdemdata)
library(tidyverse)
library(marginaleffects)
library(brms)
library(ggdist)
library(patchwork)

vdem_2015 <- vdem %>%
  select(country_name, country_text_id, year, region = e_regionpol_6C,
         media_index = v2xme_altinf, party_autonomy_ord = v2psoppaut_ord,
         polyarchy = v2x_polyarchy, civil_liberties = v2x_civlib) %>%
  filter(year == 2015) %>%
  mutate(party_autonomy = party_autonomy_ord >= 3,
         party_autonomy = ifelse(is.na(party_autonomy), FALSE, party_autonomy)) %>%
  mutate(region = factor(region,
                         labels = c("Eastern Europe and Central Asia",
                                    "Latin America and the Caribbean",
                                    "Middle East and North Africa",
                                    "Sub-Saharan Africa",
                                    "Western Europe and North America",
                                    "Asia and Pacific")))
```

Fit a basic model:

```{r, results = "hide"}
mod <- brm(
  bf(media_index ~ party_autonomy + civil_liberties + (1 | region),
     phi ~ (1 | region)),
  data = vdem_2015,
  family = Beta(),
  control = list(adapt_delta = 0.9),
  cores = 4,
  seed = 12345)
```

## Posterior predictions

To compute posterior predictions for specific values of the regressors, we use the `newdata` argument and the `typical` function. We also use the `type` argument to compute two types of predictions: accounting for residual (observation-level) residual variance (`prediction`) or ignoring it (`response`).

```{r}
pred <- predictions(mod,
                    type = c("response", "prediction"),
                    newdata = typical(party_autonomy = c(TRUE, FALSE),
                                      civil_liberties = .5,
                                      region = "Middle East and North Africa"))
pred
```

Extract posterior draws and plot them:

```{r}
pred <- get_posterior_draws(pred)

ggplot(pred, aes(x = draw, fill = party_autonomy)) +
    stat_halfeye(alpha = .5) +
    facet_wrap(~ type) +
    labs(x = "Media index (predicted)", 
         y = "Posterior density",
         fill = "Party autonomy")
```

## Marginal effects and contrasts

As noted in the [Marginal Effects vignette](https://vincentarelbundock.github.io/marginaleffects/articles/mfx.html), there should be one distinct marginal effect for each combination of regressor values. Here, we consider only one combination of regressor values, where `region` is "Middle East and North Africa", and `civil_liberties` is 0.5. Then, we calculate the mean of the posterior distribution of marginal effects:

```{r}
mfx <- marginaleffects(mod,
                       newdata = typical(civil_liberties = .5,
                                         region = "Middle East and North Africa"))
mfx
```

Use the `get_posterior_draws()` to extract draws from the posterio distribution of marginal effects, and plot them:

```{r}
mfx <- get_posterior_draws(mfx)

ggplot(mfx, aes(x = draw, y = term)) +
  stat_halfeye() +
  labs(x = "Marginal effect", y = "")
```

Plot marginal effects, conditional on a regressor:

```{r, fig.asp = .8}
plot_cme(mod,
         effect = "civil_liberties",
         condition = "party_autonomy")
```

## Continuous predictors

```{r, fig.asp = .6}
pred <- predictions(mod,
                    newdata = typical(party_autonomy = FALSE,
                                      region = "Middle East and North Africa",
                                      civil_liberties = seq(0, 1, by = 0.05))) |>
        get_posterior_draws()


ggplot(pred, aes(x = civil_liberties, y = draw)) +
    stat_lineribbon() +
    scale_fill_brewer(palette = "Reds") +
    labs(x = "Civil liberties",
         y = "Media index (predicted)",
         fill = "")
```

The slope of this line for different values of civil liberties can be obtained with:

```{r}
mfx <- marginaleffects(mod,
                       newdata = typical(civil_liberties = c(.2, .5, .8),
                                         party_autonomy = FALSE,
                                         region = "Middle East and North Africa"),
                       variables = "civil_liberties")
mfx
```

And plotted:

```{r}
mfx <- get_posterior_draws(mfx)

ggplot(mfx, aes(x = draw, fill = factor(civil_liberties))) +
    stat_halfeye(slab_alpha = .5) +
    labs(x = "Marginal effect of Civil Liberties on Media Index",
         y = "Posterior density",
         fill = "Civil liberties")
```
                                 
The `marginaleffects` function can use the ellipsis (`...`) to push any argument forward to the `posterior_predict` function. This can alter the types of predictions returned. For example, [the `re_formula=NA` argument of the `posterior_predict.brmsfit` method](https://cran.r-project.org/web/packages/brms/brms.pdf) will compute marginaleffects *without* including any group-level effects:

```{r}
mfx <- marginaleffects(mod,
                       newdata = typical(civil_liberties = c(.2, .5, .8),
                                         party_autonomy = FALSE,
                                         region = "Middle East and North Africa"),
                       variables = "civil_liberties",
                       re_formula = NA) |>
       get_posterior_draws()

ggplot(mfx, aes(x = draw, fill = factor(civil_liberties))) +
    stat_halfeye(slab_alpha = .5) +
    labs(x = "Marginal effect of Civil Liberties on Media Index",
         y = "Posterior density",
         fill = "Civil liberties")
```

```{r, eval = FALSE, include = FALSE}
library(emmeans)
emtrends(mod,
         ~ civil_liberties,
         var = "civil_liberties",
         at = list(party_autonomy = FALSE,
                   civil_liberties = c(.2, .5, .8),
                   region = "Middle East and North Africa"),
         transform = "response")
```                                  

## Global grand mean

```{r, fig.width = 9}
pred <- predictions(mod,
                    re_formula = NA,
                    newdata = typical(party_autonomy = c(TRUE, FALSE))) |>
        get_posterior_draws()

mfx <- marginaleffects(mod,
                       re_formula = NA,
                       variables = "party_autonomy") |>
       get_posterior_draws()

plot1 <- ggplot(pred, aes(x = draw, fill = party_autonomy)) +
         stat_halfeye(slab_alpha = .5) +
         labs(x = "Media index (Predicted)",
              y = "Posterior density",
              fill = "Party autonomy")

plot2 <- ggplot(mfx, aes(x = draw)) +
         stat_halfeye(slab_alpha = .5)  +
         labs(x = "Contrast: Party autonomy TRUE - FALSE",
              y = "",
              fill = "Party autonomy")

# combine plots using the `patchwork` package
plot1 + plot2
```

## Region-specific predictions and contrasts

Predicted media index by region and level of civil liberties:

```{r, out.width = "100%", fig.width = 9}
pred <- predictions(mod,
                    newdata = typical(region = vdem_2015$region,
                                      party_autonomy = FALSE, 
                                      civil_liberties = seq(0, 1, length.out = 100))) |> 
        get_posterior_draws()

ggplot(pred, aes(x = civil_liberties, y = draw)) +
    stat_lineribbon() +
    scale_fill_brewer(palette = "Reds") +
    facet_wrap(~ region) +
    labs(x = "Civil liberties",
         y = "Media index (predicted)",
         fill = "")
```

Predicted media index by region and level of civil liberties:

```{r, out.width = "100%", fig.width = 9}
pred <- predictions(mod,
                    newdata = typical(region = vdem_2015$region,
                                      civil_liberties = c(.2, .8),
                                      party_autonomy = FALSE)) |>
        get_posterior_draws()

ggplot(pred, aes(x = draw, fill = factor(civil_liberties))) +
    stat_halfeye(slab_alpha = .5) +
    facet_wrap(~ region) +
    labs(x = "Media index (predicted)",
         y = "Posterior density",
         fill = "Civil liberties")
```

Predicted media index by region and party autonomy: 

```{r, fig.asp = .9}
pred <- predictions(mod,
                    newdata = typical(region = vdem_2015$region,
                                      party_autonomy = c(TRUE, FALSE),
                                      civil_liberties = .5)) |>
        get_posterior_draws()

ggplot(pred, aes(x = draw, y = region , fill = party_autonomy)) +
    stat_halfeye(slab_alpha = .5) +
    labs(x = "Media index (predicted)",
         y = "",
         fill = "Party autonomy")
```
TRUE/FALSE contrasts (marginal effects) of party autonomy by region:

```{r, fig.asp = .9}
mfx <- marginaleffects(mod,
                       variables = "party_autonomy",
                       newdata = typical(region = vdem_2015$region,
                                         civil_liberties = .5)) |>
        get_posterior_draws()

ggplot(mfx, aes(x = draw, y = region , fill = party_autonomy)) +
    stat_halfeye(slab_alpha = .5) +
    labs(x = "Media index (predicted)",
         y = "",
         fill = "Party autonomy")
```

## Hypothetical groups

We can also obtain predictions or marginal effects for a hypothetical group instead of one of the observed regions. To achieve this, we create a dataset with `NA` in the `region` column. Then, we call the `marginaleffects` or `predictions` functions with the `re_formula=NULL` argument. This argument is pushed through via the ellipsis (`...`) to the `predict` function of `brms`:

```{r}
dat <- data.frame(civil_liberties = .5,
                  party_autonomy = FALSE,
                  region = "Atlantis")

marginaleffects(mod,
                variables = "party_autonomy",
                type = "response",
                newdata = dat,
                allow_new_levels = TRUE,
                re_formula = NULL) |>
     get_posterior_draws() |>
     ggplot(aes(x = draw)) +
     stat_halfeye()
```
